# ( Commit to any branch OR create Pull Request )
#                 |
#                 v
# +------------------------------------------+
# |             STAGE 1: Test                |
# |  (Runs for ALL commits & PRs)            |
# |                                          |
# |  (These 2 jobs run in PARALLEL)          |
# |                                          |
# |   +-------------------+  +---------------+
# |   | Job 1.1:          |  | Job 1.2:      |
# |   | Backend (Django)  |  | Frontend      |
# |   | Tests             |  | (React) Tests |
# |   +-------------------+  +---------------+
# |          |                      |
# |          +---------+  +---------+
# |                    |  |
# |                    v  v
# |              (Wait for BOTH)
# |                    |
# |             [  Success?  ]
# |                    |
# +--------------------|---------------------+
#                      |
#                      v (Only if ALL test jobs pass)
# +--------------------|---------------------+
# |             STAGE 2: Deploy              |
# | (Only runs on 'develop' or 'main' branch)|
# |                                          |
# |   [ IF branch is 'develop' ]             |
# |                |                         |
# |                v                         |
# |   +-------------------+                  |
# |   | Job 2.1:          |                  |
# |   | Build & Deploy    |                  |
# |   | to DEV            |                  |
# |   +-------------------+                  |
# |                                          |
# |   [ IF branch is 'main' ]                |
# |                |                         |
# |                v                         |
# |   +-------------------+                  |
# |   | Job 2.2:          |                  |
# |   | Build & Deploy    |                  |
# |   | to PROD           |                  |
# |   +-------------------+                  |
# |                                          |
# +------------------------------------------+

# -----------------------------------------------------------------------------
# .travis.yml for NYU Marketplace (Monorepo CI/CD)
#
# This pipeline is structured in two stages:
# 1. 'test':   Runs parallel jobs to validate backend and frontend code.
#              This is triggered on ALL commits and Pull Requests.
# 2. 'deploy': Runs jobs to build *and* deploy the application.
#              This is triggered ONLY on successful merges to 'develop' or 'main'.
# -----------------------------------------------------------------------------

# We use 'shell' as the base language because jobs
# will specify their own (python or node_js).
language: shell
os: linux
dist: noble

# Define the build stages. Jobs in 'test' run first (and in parallel).
# If all 'test' jobs pass, jobs in 'deploy' will run.
stages:
  - name: test
  - name: deploy

# Define the matrix of jobs to run
jobs:
  include:
    
    # -------------------------------------------------------------------------
    # STAGE 1: Test (CI)
    # These jobs run in parallel on every commit & PR.
    # -------------------------------------------------------------------------

    # Job 1.1: Backend (Django) Tests
    - stage: Backend (Django) Tests
      name: "Backend (Django) Tests"
      language: python
      python: "3.11"
      services:
        - mysql      # Start MySQL for testing, as required by settings.py
      
      env:
        # These are "dummy" (fake) secrets for the CI TEST environment.
        # The app needs them to run, but they don't point to real resources.
        - DJANGO_SETTINGS_MODULE=core.settings_dev
        - DJANGO_SECRET_KEY=dummy-ci-key-for-travis
        - DB_ENGINE=django.db.backends.mysql
        - DB_NAME=test_db
        - DB_USER=travis    # Travis CI default MySQL user
        - DB_PASSWORD=""    # Travis CI default MySQL password
        - DB_HOST=127.0.0.1
        - ALLOWED_HOSTS="localhost,127.0.0.1"
        - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
        - AWS_STORAGE_BUCKET_NAME=$AWS_STORAGE_BUCKET_NAME

      before_script:
        # Create the test database before running tests
        - mysql -e 'CREATE DATABASE test_db;'
        - mkdir 'backend/static'
      
      install:
        - pip install uv
        - uv pip install -r backend/requirements.txt
      
      script:
        # --- Run all backend quality checks ---
        #- echo "Running backend linters..."
        #- flake8 backend/
        #- black backend/ --check
        - echo "Running Django manage.py check..."
        - python backend/manage.py check
        - echo "Running Django collectstatic (validation)..."
        - python backend/manage.py collectstatic --noinput
        - echo "Running backend tests..."
        - pytest backend/ # Finds pyproject.toml

    # Job 1.2: Frontend (React) Tests
    - stage: "Frontend (React) Tests"
      name: "Frontend (React) Tests"
      language: node_js
      node_js: "20"     # Use a recent Node.js LTS version
      
      cache:
        directories:
          - frontend/node_modules  # Cache dependencies for faster builds
      
      install:
        # Install all Node.js frontend dependencies
        - echo "Installing frontend dependencies..."
        - cd frontend
        - npm install
        - cd ..
      
      script:
        # --- Run all frontend quality checks ---
        #- echo "Running frontend lint..."
        #- npm run lint --prefix frontend
        - echo "Running frontend tests..."
        - npm run test:run --prefix frontend
        - echo "Validating frontend production build..."
        - npm run build --prefix frontend # Just validates that the build succeeds

    # -------------------------------------------------------------------------
    # STAGE 2: Build & Deploy (CD)
    # These jobs ONLY run if the 'test' stage passes AND the commit
    # is on the 'develop' or 'main' branch of the main team repo.
    # -------------------------------------------------------------------------

    # Job 2.1: Deploy to DEV Environment
    - name: "Build & Deploy to DEV (AWS EB)"
      stage: deploy
      language: python  # Use Python for 'dpl' deploy tool
      python: "3.11"

      env: 
        - DJANGO_SETTINGS_MODULE=core.settings_dev
      
      cache: # Cache node_modules for faster build
        directories:
          - frontend/node_modules
      
      install:
        - echo "Installing deploy tools..."
        - pip install dpl # Travis CI's deploy tool
        
        - echo "Installing Node.js..."
        - nvm install 20  # Install Node.js in the Python environment
        - nvm use 20
        
        - echo "Installing frontend dependencies for build..."
        - cd frontend
        - npm install
        - cd ..

      script:
        - echo "Starting production build for frontend..."
        - cd frontend
        - npm run build  # Vite builds directly into backend/frontend_build (see vite.config.js)
        - cd ..
        - echo "Frontend build complete."
        - echo "Frontend assets built at backend/frontend_build/"
        # NOTE: No need to move files - vite.config.js already outputs to backend/frontend_build
        # The 'deploy' step below will now pick up the 'backend' folder
        # which contains the newly built frontend.
      
      deploy:
        provider: elasticbeanstalk
        # These are *secure* variables set in the Travis CI project settings.
        # They are the REAL keys for your AWS deployment user.
        access_key_id: $AWS_ACCESS_KEY_ID
        secret_access_key: $AWS_SECRET_ACCESS_KEY
        
        # --- Fill in your AWS "Dev" Environment Details ---
        region: "us-east-1" # (From your settings.py)
        app: "nyu-marketplace" # (Your EB Application Name)
        env: "nyu-marketplace-dev" # (Your "dev" EB Environment Name)
        bucket: "your-eb-deploy-s3-bucket" # (Your EB S3 bucket)
        
        # --- Monorepo Configuration ---
        edge: true           # Use the newer 'dpl v2'
        
        cleanup: false # Don't remove files before deploying
        on:
          branch: develop
          repo: iridiumtao/NYU-Marketplace

    # Job 2.2: Deploy to PROD Environment
    - name: "Build & Deploy to PROD (AWS EB)"
      stage: deploy
      language: python
      python: "3.11"

      env: 
        - DJANGO_SETTINGS_MODULE=core.settings_prod

      cache:
        directories:
          - frontend/node_modules
      
      install:
        # This is identical to the 'dev' deploy job
        - echo "Installing deploy tools..."
        - pip install dpl
        - echo "Installing Node.js..."
        - nvm install 20
        - nvm use 20
        - echo "Installing frontend dependencies for build..."
        - cd frontend
        - npm install
        - cd ..

      script:
        # This is identical to the 'dev' deploy job
        - echo "Starting production build for frontend..."
        - cd frontend
        - npm run build  # Vite builds directly into backend/frontend_build (see vite.config.js)
        - cd ..
        - echo "Frontend build complete."
        - echo "Frontend assets built at backend/frontend_build/"
        # NOTE: No need to move files - vite.config.js already outputs to backend/frontend_build
      
      deploy:
        provider: elasticbeanstalk
        access_key_id: $AWS_ACCESS_KEY_ID
        secret_access_key: $AWS_SECRET_ACCESS_KEY
        
        # --- Fill in your AWS "Prod" Environment Details ---
        region: "us-east-1"
        app: "nyu-marketplace" # (Likely same as dev)
        env: "nyu-marketplace-prod" # (Your "prod" EB Environment Name)
        bucket: "your-eb-deploy-s3-bucket" # (Likely same as dev)
        
        # --- Monorepo Configuration ---
        edge: true
        
        cleanup: false
        on:
          branch: main
          repo: gcivil-nyu-org/team3-mon-fall25

# -----------------------------------------------------------------------------
# (Optional but Recommended) Disable email spam
notifications:
  email: false