# ( Commit to any branch OR create Pull Request )
#                      |
#                      v
# +---------------------------------------------+
# |             STAGE 1: Test                   |
# |  (Runs for ALL commits & PRs)               |
# |                                             |
# |  (These 2 jobs run in PARALLEL)             |
# |                                             |
# |   +-------------------+  +------------------+
# |   | Job 1.1:          |  | Job 1.2:         |
# |   | Backend (Django)  |  | Frontend (React) |
# |   | - check           |  | - Tests          |
# |   | - collectstatic   |  | - Coverage       |
# |   | - Tests           |  | - Build Check    |
# |   | - Coverage (85%)  |  |                  |
# |   | - Coveralls       |  |                  |
# |   +-------------------+  +------------------+
# |          |                      |           |
# |          +---------+  +---------+           |
# |                    |  |                     |
# |                    v  v                     |
# |              (Wait for BOTH)                |
# |                    |                        |
# |             [  Success?  ]                  |
# |                    |                        |
# +--------------------|------------------------+
#                      |
#                      v (Only if ALL test jobs pass)
# +--------------------|------------------------+
# |             STAGE 2: Deploy                 |
# |                                             |
# |           +----------------------+          |
# |           | Job 2:               |          |
# |           | Finalize Coverage &  |          |
# |           | Deploy to AWS EB     |          |
# |           | - Merge parallel     |          |
# |           |   coverage           |          |
# |           |   (all branches)     |          |
# |           | - Build Frontend     |          |
# |           |   (all branches)     |          |
# |           | - Package & Deploy:  |          |
# |           |   * DEV (develop)    |          |
# |           |   * PROD (main)      |          |
# |           +----------------------+          |
# |                                             |
# +---------------------------------------------+
#

# -----------------------------------------------------------------------------
# .travis.yml for NYU Marketplace (Monorepo CI/CD)
#
# This pipeline is structured in two stages:
# 1. 'test':   Runs parallel jobs to validate backend and frontend code.
#              This is triggered on ALL commits and Pull Requests.
# 2. 'deploy': Runs jobs to build *and* deploy the application
#              on successful merges to 'develop' or 'main'.
# -----------------------------------------------------------------------------

language: shell
os: linux
dist: noble

# specify the order for stages 
stages:
  - name: test
  - name: deploy

# Define the matrix of jobs to run
jobs:
  include:
    
    # -------------------------------------------------------------------------
    # STAGE 1: Test (CI)
    # These jobs run in parallel on every commit & PR.
    # -------------------------------------------------------------------------

    # Job 1.1: Backend (Django) Tests
    - stage: test
      name: "Backend (Django) Tests"
      
      language: python
      python: "3.11"
      services:
        - mysql      # Start MySQL for testing, as required by settings.py
      
      env:
        # These are "dummy" (fake) secrets for the CI TEST environment.
        # The app needs them to run, but they don't point to real resources.
        - DJANGO_SETTINGS_MODULE=core.settings_dev
        - DJANGO_SECRET_KEY=dummy-ci-key-for-travis
        - DB_ENGINE=django.db.backends.mysql
        - DB_NAME=test_db
        - DB_USER=travis    # Travis CI default MySQL user
        - DB_PASSWORD=""    # Travis CI default MySQL password
        - DB_HOST=127.0.0.1
        - ALLOWED_HOSTS="localhost,127.0.0.1"
        - AWS_ACCESS_KEY_ID=$AWS_ACCESS_KEY_ID
        - AWS_SECRET_ACCESS_KEY=$AWS_SECRET_ACCESS_KEY
        - AWS_STORAGE_BUCKET_NAME=$AWS_STORAGE_BUCKET_NAME

      before_script:
        # Create the test database before running tests
        - mysql -e 'CREATE DATABASE test_db;'
        - mkdir 'backend/static'
      
      install:
        - pip install uv
        - uv pip install -r backend/requirements.txt
      
      script:
        # --- Run all backend quality checks ---
        - echo "Running backend linters..."
        - flake8 backend/
        - black backend/ --check
        - echo "Running Django manage.py check..."
        - python backend/manage.py check
        - echo "Running Django collectstatic (validation)..."
        - python backend/manage.py collectstatic --noinput
        - echo "Running backend tests with coverage..."
        - cd backend
        - pytest -n auto --cov=. --cov-report=term --cov-report=lcov --cov-fail-under=85
        - cd ..
      
      after_success:
        # Upload coverage to Coveralls with parallel flag (this job runs in parallel with frontend)
        - echo "Uploading backend coverage to Coveralls..."
        - cd backend && cat coverage.lcov | coveralls --parallel || echo "Coveralls upload failed or not configured"

    # Job 1.2: Frontend (React) Tests
    - name: "Frontend (React) Tests"
      language: node_js
      node_js: "20"     # Use a recent Node.js LTS version
      
      cache:
        directories:
          - frontend/node_modules  # Cache dependencies for faster builds
      
      install:
        # Install all Node.js frontend dependencies
        - echo "Installing frontend dependencies..."
        - cd frontend
        - npm install
        - cd ..
      
      script:
        # --- Run all frontend quality checks ---
        - echo "Running frontend lint..."
        - npm run lint --prefix frontend
        - echo "Running frontend tests with coverage..."
        - npm run test:coverage --prefix frontend
        - echo "Validating frontend production build..."
        - npm run build --prefix frontend # Just validates that the build succeeds
      
      after_success:
        # Upload coverage to Coveralls with parallel flag (this job runs in parallel with backend)
        - cd frontend && cat coverage/lcov.info | npx coveralls --parallel || echo "Coveralls upload failed or not configured"

    # -------------------------------------------------------------------------
    # STAGE 2: Deploy (CD)
    # This job ONLY runs if the 'test' stage passes.
    # - Finalize Coveralls runs on ALL branches (to complete coverage merge)
    # - Build, then Deploy to AWS runs ONLY on 'develop' or 'main' branch of the main team repo.
    # -------------------------------------------------------------------------
    
    # Job 2: Finalize Coverage, Build & Deploy
    - stage: deploy
      name: "Finalize Coverage, Build & Deploy to AWS EB"
      language: node_js
      node_js: "20"
      
      cache:
        directories:
          - frontend/node_modules
      
      install:
        - echo "Installing frontend dependencies for build..."
        - cd frontend
        - npm install
        - cd ..

      script:
        # Finalize Coveralls (runs on ALL branches)
        - echo "Notifying Coveralls that all parallel testing jobs are complete..."
        - 'curl -k https://coveralls.io/webhook?repo_token=$COVERALLS_REPO_TOKEN -d "payload[build_num]=$TRAVIS_BUILD_NUMBER&payload[status]=done"'
        # Build frontend (runs on ALL branches, but only needed for develop/main)
        - echo "Starting production build for frontend..."
        - cd frontend
        - |
          if [[ "$TRAVIS_BRANCH" == "develop" ]]; then
            echo "Building for DEV environment..."
            npm run build:dev
          elif [[ "$TRAVIS_BRANCH" == "main" ]]; then
            echo "Building for PROD environment..."
            npm run build:prod
          else
            echo "Unknown branch for deployment: $TRAVIS_BRANCH"
            exit 1
          fi
        - cd ..
        - echo "Frontend build complete."
      
      # package the backend directory into a zip file to only deploy the backend code
      before_deploy:
        - echo "Creating deployment package from backend directory..."
        - cd backend
        - zip -r ../deploy.zip . -x "*.git*" -x "*__pycache__*" -x "*.pyc"
        - cd ..
        - ls -lh deploy.zip
      
      deploy:
        # Deploy to DEV
        - provider: elasticbeanstalk
          access_key_id: $AWS_ACCESS_KEY_ID
          secret_access_key: $AWS_SECRET_ACCESS_KEY
          region: "us-east-1"
          app: "nyu-marketplace"
          env: "nyu-marketplace-dev"
          bucket: "nyu-marketplace-dev-images"
          edge: true
          zip_file: deploy.zip
          label: "dev-build-$TRAVIS_BUILD_NUMBER-$TRAVIS_COMMIT"
          wait_until_deployed: true
          wait_until_deployed_timeout: 900
          on:
            branch: develop
            repo: gcivil-nyu-org/team3-mon-fall25
        
        # Deploy to PROD
        - provider: elasticbeanstalk
          access_key_id: $AWS_ACCESS_KEY_ID
          secret_access_key: $AWS_SECRET_ACCESS_KEY
          region: "us-east-1"
          app: "nyu-marketplace"
          env: "nyu-marketplace-env"
          bucket: "nyu-marketplace-images"
          edge: true
          zip_file: deploy.zip
          label: "prod-build-$TRAVIS_BUILD_NUMBER-$TRAVIS_COMMIT"
          wait_until_deployed: true
          wait_until_deployed_timeout: 900
          on:
            branch: main
            repo: gcivil-nyu-org/team3-mon-fall25