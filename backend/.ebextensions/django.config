packages:
  yum:
    gcc: []
    python3-devel: []
    mariadb105-devel: []

option_settings:
    aws:elasticbeanstalk:application:environment:
        DJANGO_SETTINGS_MODULE: "core.settings"
        # Ensure the inner 'core' folder (where manage.py and the project package live)
        # is on the PYTHONPATH so imports resolve when the app is deployed from the repo root.
        PYTHONPATH: "/var/app/current/core:/var/app/current"

    aws:elasticbeanstalk:container:python:
        # Use forward slashes and the path relative to the application root.
        WSGIPath: "core/wsgi.py"
container_commands:
  00_wait_for_db: # Spare time to connect db in case of unreachable
    command: |
      bash -lc '
        H="${DB_HOST}"; P="${DB_PORT:-3306}";
        echo "Waiting for MySQL at $H:$P ..."
        for i in {1..30}; do
          (echo > /dev/tcp/$H/$P) >/dev/null 2>&1 && { echo "DB is up"; exit 0; }
          echo "not ready yet... ($i)"; sleep 5
        done
        echo "DB not reachable" >&2; exit 1
      '
    leader_only: true

  01_migrate:
    command: "python manage.py migrate --noinput"
    leader_only: true

  02_collectstatic:
    command: "python manage.py collectstatic --noinput"
    leader_only: true