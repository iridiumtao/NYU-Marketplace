packages:
  yum:
    gcc: []
    python3-devel: []
    mariadb105-devel: []

option_settings:
    aws:elasticbeanstalk:application:environment:
        # DJANGO_SETTINGS_MODULE: "core.settings_dev"
        # Ensure the inner 'core' folder (where manage.py and the project package live)
        # is on the PYTHONPATH so imports resolve when the app is deployed from the repo root.
        PYTHONPATH: "/var/app/current/core:/var/app/current"

    aws:elasticbeanstalk:container:python:
        # Use forward slashes and the path relative to the application root.
        WSGIPath: "core/wsgi.py"
container_commands:
  00_wait_for_db: # Spare time to connect db in case of unreachable
    command: |
      bash -lc '
        H="${DB_HOST}"; P="${DB_PORT:-3306}";
        echo "Waiting for MySQL at $H:$P ..."
        for i in {1..30}; do
          (echo > /dev/tcp/$H/$P) >/dev/null 2>&1 && { echo "DB is up"; exit 0; }
          echo "not ready yet... ($i)"; sleep 5
        done
        echo "DB not reachable" >&2; exit 1
      '
    leader_only: true

  01_test_db_connection:
    command: |
      cd /var/app/staging
      export PYTHONPATH=/var/app/staging/core:/var/app/staging:$PYTHONPATH
      echo "Testing database connection..."
      python << EOF
      import os
      os.environ.setdefault('DJANGO_SETTINGS_MODULE', os.getenv('DJANGO_SETTINGS_MODULE', 'core.settings_dev'))
      import django
      django.setup()
      from django.db import connection
      try:
          with connection.cursor() as cursor:
              cursor.execute("SELECT 1")
          print("✓ Database connection successful!")
      except Exception as e:
          print(f"✗ Database connection failed: {e}")
          import traceback
          traceback.print_exc()
          exit(1)
      EOF
    leader_only: true

  02_migrate:
    command: |
      cd /var/app/staging
      export PYTHONPATH=/var/app/staging/core:/var/app/staging:$PYTHONPATH
      echo "Running migrations..."
      echo "Current directory: $(pwd)"
      echo "DJANGO_SETTINGS_MODULE: $DJANGO_SETTINGS_MODULE"
      echo "DB_HOST: $DB_HOST"
      echo "DB_NAME: $DB_NAME"
      echo "DB_USER: $DB_USER"
      python manage.py migrate --noinput --verbosity 2
    leader_only: true

  03_collectstatic:
    command: |
      cd /var/app/staging
      export PYTHONPATH=/var/app/staging/core:/var/app/staging:$PYTHONPATH
      python manage.py collectstatic --noinput
    leader_only: true